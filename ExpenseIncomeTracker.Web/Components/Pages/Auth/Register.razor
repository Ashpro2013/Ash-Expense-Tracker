@page "/register"
@attribute [AllowAnonymous]
@rendermode InteractiveServer
@layout ExpenseIncomeTracker.Web.Components.Layout.AuthLayout

<PageTitle>Sign up</PageTitle>

@using System.Text.Json.Serialization
@inject IJSRuntime JS
@inject NavigationManager Navigation

<MudPaper Elevation="0" Style="padding: 2rem;">

    <MudStack Spacing="3">
        <MudStack Spacing="1">
            <MudText Typo="Typo.h4" Style="font-weight: 600;">
                Create your account
            </MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                Start tracking income and expenses in minutes.
            </MudText>
        </MudStack>

        <!-- REGISTER FORM -->
        <MudForm @ref="_form">
            <MudStack Spacing="3">
                <!-- EMAIL -->
                <MudTextField T="string"
                              @bind-Value="_model.Email"
                              Label="Email"
                              Variant="Variant.Outlined"
                              FullWidth="true"
                              Required="true"
                              RequiredError="Email is required"
                              Immediate="true" />

                <!-- PASSWORD -->
                <MudTextField T="string"
                              @bind-Value="_model.Password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              FullWidth="true"
                              Required="true"
                              RequiredError="Password is required"
                              Immediate="true" />

                <!-- CONFIRM PASSWORD -->
                <MudTextField T="string"
                              @bind-Value="_model.ConfirmPassword"
                              Label="Confirm Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              FullWidth="true"
                              Required="true"
                              RequiredError="Confirm password is required"
                              Immediate="true" />

                <!-- ERROR MESSAGE -->
                @if (!string.IsNullOrWhiteSpace(Error))
                {
                    <MudAlert Severity="Severity.Error"
                              Variant="Variant.Outlined">
                        @Error
                    </MudAlert>
                }

                <!-- SUBMIT -->
                <MudButton ButtonType="ButtonType.Button"
                           Color="Color.Secondary"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="@_submitting"
                           OnClick="SubmitRegister">
                    <span>Sign up</span>
                </MudButton>
            </MudStack>
        </MudForm>

        <!-- FOOTER -->
        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
            Already registered?
            <MudLink Href="/login">Sign in</MudLink>
        </MudText>
    </MudStack>

</MudPaper>

@code {
    private MudForm? _form;
    private RegisterModel _model = new();
    private bool _submitting;


    [SupplyParameterFromQuery(Name = "error")]
    public string? Error { get; set; }

    private async Task SubmitRegister()
    {
        if (_form is null)
        {
            return;
        }

        await _form.Validate();
        if (!_form.IsValid)
        {
            return;
        }

        _submitting = true;
        Error = null;

        var response = await JS.InvokeAsync<AuthResponse>(
            "authForms.postJson",
            "/account/register-json",
            new RegisterRequest(_model.Email, _model.Password, _model.ConfirmPassword));

        if (response.Ok)
        {
            Navigation.NavigateTo(response.Redirect ?? "/dashboard", true);
            return;
        }

        Error = response.Error ?? "Registration failed.";
        _submitting = false;
    }

    private sealed class RegisterModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private sealed record RegisterRequest(string Email, string Password, string ConfirmPassword);

    private sealed class AuthResponse
    {
        [JsonPropertyName("ok")]
        public bool Ok { get; set; }

        [JsonPropertyName("redirect")]
        public string? Redirect { get; set; }

        [JsonPropertyName("error")]
        public string? Error { get; set; }
    }
}
